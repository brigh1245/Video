<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Video and Audio Sharing (WebRTC)</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 20px;
    }
    video {
      border: 2px solid #ccc;
      width: 100%;
      max-width: 600px;
      margin: 10px auto;
    }
    input, button {
      margin: 10px;
      padding: 10px;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <h1>Video and Audio Sharing</h1>

  <h3>Your Session ID: <span id="sessionIdDisplay"></span></h3>

  <!-- Local Video -->
  <video id="localVideo" autoplay muted playsinline></video>

  <!-- Remote Video -->
  <video id="remoteVideo" autoplay playsinline></video>

  <div>
    <label for="offer">Enter SDP Offer:</label>
    <input type="text" id="offer" placeholder="Enter SDP Offer" />
    <button id="connectBtn">Connect</button>
  </div>

  <script>
    // Get video elements and buttons
    const localVideo = document.getElementById('localVideo');
    const remoteVideo = document.getElementById('remoteVideo');
    const offerInput = document.getElementById('offer');
    const connectBtn = document.getElementById('connectBtn');

    let localStream;
    let peerConnection;
    let remoteStream;
    let sessionId = Math.floor(Math.random() * 10000);  // Random session ID to share

    document.getElementById('sessionIdDisplay').textContent = sessionId;

    // ICE Server configuration (this will enable NAT traversal for peer connections)
    const iceServers = {
      iceServers: [
        { urls: "stun:stun.l.google.com:19302" },  // Google's public STUN server
        { urls: "turn:YOUR_TURN_SERVER" }  // Optional: Add your TURN server here if needed
      ]
    };

    // Get user's media (video and audio)
    navigator.mediaDevices.getUserMedia({ video: true, audio: true })
      .then((stream) => {
        localStream = stream;
        localVideo.srcObject = stream;
      })
      .catch((error) => {
        console.error('Error accessing media devices:', error);
        alert('Error accessing your camera and microphone. Please allow permission.');
      });

    // Create a new RTC connection
    function createPeerConnection() {
      peerConnection = new RTCPeerConnection(iceServers);

      // Add the local stream to the connection
      localStream.getTracks().forEach(track => {
        peerConnection.addTrack(track, localStream);
      });

      // Set up the remote stream when a connection is established
      peerConnection.ontrack = (event) => {
        remoteStream = event.streams[0];
        remoteVideo.srcObject = remoteStream;
      };

      // Handle ICE candidates (for establishing connection)
      peerConnection.onicecandidate = (event) => {
        if (event.candidate) {
          console.log("ICE Candidate:", event.candidate);
        }
      };
    }

    // Create an offer and share the SDP
    connectBtn.addEventListener('click', () => {
      if (!offerInput.value) {
        alert("Please enter the SDP offer.");
        return;
      }

      const sdpOffer = offerInput.value; // Get the SDP offer from the input
      const sessionDescription = new RTCSessionDescription({
        type: 'offer',
        sdp: sdpOffer
      });

      // Create the peer connection and set the remote description
      createPeerConnection();
      peerConnection.setRemoteDescription(sessionDescription)
        .then(() => {
          return peerConnection.createAnswer(); // Create an answer to the offer
        })
        .then((answer) => {
          return peerConnection.setLocalDescription(answer); // Set the local answer
        })
        .then(() => {
          // Optionally, send the SDP answer back to the offerer using signaling (e.g., WebSocket or REST)
          alert("Connection Established!");
        })
        .catch((error) => {
          console.error("Error during connection setup:", error);
          alert("Error during connection setup.");
        });
    });

    // Send the SDP Offer to the peer (this would normally happen through a signaling server)
    // You need to manually copy the generated SDP Offer to the other peer and paste it into the input
    function generateSDPOffer() {
      createPeerConnection();

      peerConnection.createOffer()
        .then((offer) => {
          return peerConnection.setLocalDescription(offer);
        })
        .then(() => {
          offerInput.value = peerConnection.localDescription.sdp;  // Display the generated SDP offer
          alert("SDP Offer is ready to be copied and shared!");
        })
        .catch((error) => {
          console.error("Error generating offer:", error);
        });
    }

    // Call generateSDPOffer to generate an SDP offer and display it
    window.onload = generateSDPOffer;
  </script>
</body>
</html>
